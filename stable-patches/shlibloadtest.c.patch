diff --git a/test/shlibloadtest.c b/test/shlibloadtest.c
index 5dc42a0..887646f 100644
--- a/test/shlibloadtest.c
+++ b/test/shlibloadtest.c
@@ -1,3 +1,4 @@
+#include <stdio.h>
 /*
  * Copyright 2016-2021 The OpenSSL Project Authors. All Rights Reserved.
  *
@@ -7,7 +8,6 @@
  * https://www.openssl.org/source/license.html
  */
 
-#include <stdio.h>
 #include <string.h>
 #include <stdlib.h>
 #include <openssl/opensslv.h>
@@ -169,6 +169,14 @@ static int test_lib(void)
         goto end;
     }
 
+    if (test_type != NO_ATEXIT) {
+        if (!sd_sym(cryptolib, "OPENSSL_cleanup", &symbols[0].sym)) {
+            fprintf(stderr, "Failed to load OPENSSL_cleanup symbol\n");
+            goto end;
+        }
+        ((void (*)(void))symbols[0].func)();
+    }
+
     if (test_type == DSO_REFTEST) {
 # ifdef DSO_DLFCN
         DSO_dsobyaddr_t myDSO_dsobyaddr;
@@ -285,8 +293,10 @@ int main(int argc, char *argv[])
     }
 
 #ifdef SD_INIT
-    if (!test_lib())
+    if (!test_lib()) {
         return 1;
+    }
+#else
 #endif
     return 0;
 }
